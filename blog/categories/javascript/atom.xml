<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: javascript | !geek]]></title>
  <link href="http://tech.endeepak.com/blog/categories/javascript/atom.xml" rel="self"/>
  <link href="http://tech.endeepak.com/"/>
  <updated>2014-05-18T16:33:40+05:30</updated>
  <id>http://tech.endeepak.com/</id>
  <author>
    <name><![CDATA[Deepak Narayana Rao]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Javascript functions in JSON configuration]]></title>
    <link href="http://tech.endeepak.com/blog/2014/05/18/javascript-functions-in-json-configuration"/>
    <updated>2014-05-18T15:20:32+05:30</updated>
    <id>http://tech.endeepak.com/blog/2014/05/18/javascript-functions-in-json-configuration</id>
    <content type="html"><![CDATA[<p>There is no native support for defining functions in JSON. Commonly used approach is to define function as string and use <code>eval()</code> or <code>new Function()</code> to contruct the function. The basic difference between these two are</p>

<ul>
<li><code>eval()</code> works within the current execution scope. It can access or modify local variables.</li>
<li><code>new Function()</code> runs in a separate scope. It cannot access or modify local variables.</li>
</ul>


<p>These samples show how the json would differ in these two cases</p>

<!-- More -->


<p>```js Using eval()
// JSON config
{</p>

<pre><code>section: "Additional Details",
showIf: "function(context) { return context.person.age &gt; 60; }"
</code></pre>

<p>}</p>

<p>//This can parsed in javascript as
var showIf = eval(&lsquo;(&rsquo; + config.showIf + &lsquo;)&rsquo;)
var shouldShowThisSection = showIf({person: personData}));
```</p>

<p>```js Using new Function()
// JSON config
{</p>

<pre><code>section: "Additional Details",
showIf: "return context.person.age &gt; 60"
</code></pre>

<p>}</p>

<p>//This can parsed in javascript as
var showIf = new Function(&lsquo;context&rsquo;, config.showIf)
var shouldShowThisSection = showIf({person: personData}));
```</p>

<p>You can use either based on the use case in your application. In <a href="http://bahmni.org">bahmni</a>, we went with <code>new Function()</code> for couple of reasons</p>

<ul>
<li>We did not want config code to modify variables in application execution scope by mistake.</li>
<li>We wanted to control the function signature such as number of parameters and its name to keep it simple and less error prone.</li>
</ul>


<p>If you prefer using <code>eval</code> syntax, try <a href="https://github.com/vkiryukhin/jsonfn">vkiryukhin/jsonfn</a>.</p>

<h4>Multi line functions</h4>

<p>The above examples work fine for sinle line expressions. If you need multiple line functions, you need to tweak it a bit. Firstly, JSON does not support multiline string. The work around is to define an array of strings as shown below.</p>

<p>```js Multi line functions parsed using new Function()
// JSON config
{</p>

<pre><code>section: "Additional Details",
showIf: ["if(context.person.gender === 'M' &amp;&amp; context.person.age &gt; 60)",
            "return true;", 
         "else if(context.person.gender === 'F' &amp;&amp; context.person.age &gt; 55)",
            "return true;", 
        "else",
            "return false;"] 
</code></pre>

<p>}</p>

<p>//This can parsed in javascript as
var showIf = new Function(&lsquo;context&rsquo;, config.showIf.join(&ldquo;\n&rdquo;))
var shouldShowThisSection = showIf({person: personData}));
```</p>

<h4>Performance</h4>

<p>There is not much difference in performance when you define a function using <code>function() {}</code> expression <code>eval(&lsquo;function() {}&rsquo;)</code> or <code>new Function()</code>. Have a look at this <a href="http://jsperf.com/function-vs-new-function-vs-eval-function">benchmark</a> using jsperf.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Spinners in single page apps]]></title>
    <link href="http://tech.endeepak.com/blog/2014/05/11/spinners-in-single-page-apps"/>
    <updated>2014-05-11T16:55:23+05:30</updated>
    <id>http://tech.endeepak.com/blog/2014/05/11/spinners-in-single-page-apps</id>
    <content type="html"><![CDATA[<p>One of the good practices in single page apps, is to show spinners (overlay + loading icon) while retrieving data or saving asynchronously. Often people tend to add a generic interceptor to show spinner for all ajax calls. In any mid size app, you will realize that the assumption <strong>&ldquo;Show an overlay for all ajax call&rdquo;</strong> is incorrect. Few examples</p>

<ul>
<li>An <a href="http://jqueryui.com/autocomplete/">autocomplete</a> input box fetching reote data</li>
<li>An infininte scroll fetching more data as the use scrolls down the list.</li>
</ul>


<!-- More -->


<p>To solve this, one might add an option in interceptor to not show spinner for certain calls. This leads to complicated code due to initial wrong assumption. A better soultion is to have simple reusable code to show/hide spinner and use it explicitly for calls which need spinner.</p>

<p>If you are using a library which returns a promise for ajax call(or object like xhr returned by jQuery.ajax), the API and implementation would look like this.</p>

<p>```js Api should be simple as
spinner.forPromise($http.get(&lsquo;/items&rsquo;)) //AngularJS</p>

<p>spinner.forPromise($.ajax(&lsquo;/items&rsquo;)) //jQuery
```</p>

<p>```js Simple Spinner Implementation in AngularJS
myModule.factory(&lsquo;spinner&rsquo;, function () {</p>

<pre><code>var forPromise = function(promise) {
    $('#overlay').show();
    promise['finally'](function(){ //use promise.always(hide) in jQuery
        $('#overlay').hide();
    }); 
};

return { forPromise: forPromise }
</code></pre>

<p> )
```</p>

<p>If you have a multiple components of the page using same spinner, we need to enhance the the code to make sure spinner is hidden only after both components have completed async calls. This can be implemented by keeping spinner count as shown below.</p>

<p>```js Muliple Call Supported Spinner Implementation in AngularJS
myModule.factory(&lsquo;spinner&rsquo;, function () {</p>

<pre><code>var showCount = 0;

var show = function () {
    showCount++;
    $('#overlay').show();
}

var hide = function () {
    showCount--;
    if(showCount === 0) {
        $('#overlay').hide();
    }
}

var forPromise = function(promise) {
    show();
    promise['finally'](hide); //use promise.always(hide) in jQuery
};

return { forPromise: forPromise };
</code></pre>

<p> )
```</p>

<p>In <a href="http://www.bahmni.org">Bahmni</a>, we use a spinner with animation which can be found <a href="https://github.com/Bhamni/openmrs-module-bahmniapps/blob/master/ui/app/common/ui-helper/spinner.js">here</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Printing external html templates using AngularJS]]></title>
    <link href="http://tech.endeepak.com/blog/2014/05/03/printing-external-html-templates-using-angularjs"/>
    <updated>2014-05-03T20:50:48+05:30</updated>
    <id>http://tech.endeepak.com/blog/2014/05/03/printing-external-html-templates-using-angularjs</id>
    <content type="html"><![CDATA[<h2>Use case</h2>

<p>In <a href="http://bahmni.org">Bahmni</a> EMR we needed to support customizable html templates for printing patient regisatrtion card and other printable documents. We needed a print API which looks like</p>

<p>```js
//Contract
printer.print(templateUrl, data)</p>

<p>//This would called on clicking the print button
printer.print(&lsquo;/config/registrationCardTempate.html&rsquo;, {patient: {name: &lsquo;Ram Kumar&rsquo;, dateOfBirth: &lsquo;1978-08-23&rsquo;, gender: &rsquo;M'}})
```</p>

<!-- more -->


<p>Sample html template</p>

<p>```html
<link rel="stylesheet" href="http://tech.endeepak.com/config/registrationCard.css"/>
<img src="http://tech.endeepak.com/config/logo.jpg"><img></p>

<h1>The hospital name</h1>


<table>
    <tr><td>Name</td><td ng-bind="patient.name"></td></tr>
    <tr><td>Age</td><td ng-bind="patient.dateOfBirth | age"></td></tr>
    <tr><td>Gender</td><td ng-bind="patient.gender"></td></tr>
</table>


<p>```</p>

<h2>Implementation</h2>

<p>As the app is built using angularjs, we decided to use angular as the templating engine for rendering these templates as well. This also helped to reuse filters and other templating features of angular. The implementation consists of following steps</p>

<ol>
<li>Fetch the html template</li>
<li>Compile the html template with given data using angular&rsquo;s $complile</li>
<li>Wait for angular to complete rendering the template (Explained <a href="http://tech.endeepak.com/blog/2014/05/03/waiting-for-angularjs-digest-cycle">here</a>)</li>
<li>Print the html(Explained <a href="http://tech.endeepak.com/blog/2014/05/03/printing-html-with-image-and-css">here</a>)</li>
</ol>


<p>The code for print function looks like this</p>

<p>```js
var print = function (templateUrl, data) {</p>

<pre><code>$http.get(templateUrl).success(function(template){
    var printScope = angular.extend($rootScope.$new(), data);
    var element = $compile($('&lt;div&gt;' + template + '&lt;/div&gt;'))(printScope);
    var waitForRenderAndPrint = function() {
        if(printScope.$$phase || $http.pendingRequests.length) {
            $timeout(waitForRenderAndPrint);
        } else {
            printHtml(element.html());
            printScope.$destroy(); // To avoid memory leaks from scope create by $rootScope.$new()
        }
    }
    waitForRenderAndPrint();
});
</code></pre>

<p>};
```
The complete solution is available on <a href="https://github.com/Bhamni/openmrs-module-bahmniapps/blob/master/ui/app/common/ui-helper/printer.js">github</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Waiting for AngularJS digest cycle]]></title>
    <link href="http://tech.endeepak.com/blog/2014/05/03/waiting-for-angularjs-digest-cycle"/>
    <updated>2014-05-03T17:43:34+05:30</updated>
    <id>http://tech.endeepak.com/blog/2014/05/03/waiting-for-angularjs-digest-cycle</id>
    <content type="html"><![CDATA[<p>The million dollar question most of the AngularJS users(devs) end up asking is</p>

<ul>
<li>How to wait for angular digest cycle to be completed?  <em>or in simple terms</em></li>
<li>How to wait for browser to complete rendering the view with angular bindings?</li>
</ul>


<!-- more -->


<p>AngularJS does not raise any event to notify this. The suggested simple solution is to use $timeout to queue your work to be run after current digest cycle (also waits for DOM renedering to be completed by the browser).</p>

<p>```js
$timeout(function(){</p>

<pre><code>//the code which needs to run after dom rendering
</code></pre>

<p>})
```</p>

<p>The above solution works only for views which don&rsquo;t have ng-include or directives with template url. In this case you have to wait for all the templates to be loaded(async) and then run your code. This can be achived by waiting for <a href="https://docs.angularjs.org/api/ng/service/$http#pendingRequests">$http.pendingRequests</a> to be zero. The enhanced solution is</p>

<p>```js
var waitForRenderAndDoSomething = function() {</p>

<pre><code>if($http.pendingRequests.length &gt; 0) {
    $timeout(waitForRenderAndDoSomething); // Wait for all templates to be loaded
} else {
    //the code which needs to run after dom rendering
}
</code></pre>

<p>}
$timeout(waitForRenderAndDoSomething); // Waits for first digest cycle
```</p>

<p>Hopefully AngularJS will come up with a easier solution in future releases.</p>

<h4>Note</h4>

<p>The <a href="https://docs.angularjs.org/api/ng/service/$http#pendingRequests">$http.pendingRequests</a> supposed to be used for debugging purpose only. If angular team decides to remove this, you can implement the same using http interceptors as suggested in this <a href="http://stackoverflow.com/a/20062899/69362">link</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Printing html with image and css]]></title>
    <link href="http://tech.endeepak.com/blog/2014/05/03/printing-html-with-image-and-css"/>
    <updated>2014-05-03T16:54:00+05:30</updated>
    <id>http://tech.endeepak.com/blog/2014/05/03/printing-html-with-image-and-css</id>
    <content type="html"><![CDATA[<p>There are plenty of examples for printing html of an element. Most of them look like this</p>

<p>```js
//The simple soultion but has few problems listed below.
function printHtml(html)
{</p>

<pre><code>var mywindow = window.open();
mywindow.document.write('&lt;html&gt;&lt;head&gt;&lt;title&gt;My App&lt;/title&gt;');
mywindow.document.write('&lt;/head&gt;&lt;body&gt;');
mywindow.document.write(html);
mywindow.document.write('&lt;/body&gt;&lt;/html&gt;');
mywindow.print();
mywindow.close();
return true;
</code></pre>

<p>}
```
The issues with above solution:</p>

<!-- more -->


<ol>
<li>The new window pop up would be blocked by browsers. Users need to enable pop up.</li>
<li>If you have external css files, you will notice the styling not applied some times.</li>
<li>If you have images(like logo), the print will be missing these images intermittently.</li>
</ol>


<p>The first issue can be addressed by using an iframe instead of new window. The 2nd and 3rd issues are addressed by making sure print happens after page has loaded css files and images. The working solution we use in <a href="http://www.bahmni.org">Bahmni</a> for printing patient registration cards looks like this</p>

<p>```js
var printHtml = function (html) {</p>

<pre><code>var hiddenFrame = $('&lt;iframe style="display: none"&gt;&lt;/iframe&gt;').appendTo('body')[0];
hiddenFrame.contentWindow.printAndRemove = function() {
    hiddenFrame.contentWindow.print();
    $(hiddenFrame).remove();
};
var htmlDocument = "&lt;!doctype html&gt;"+
            "&lt;html&gt;"+
                '&lt;body onload="printAndRemove();"&gt;' + // Print only after document is loaded
                    html +
                '&lt;/body&gt;'+
            "&lt;/html&gt;";
var doc = hiddenFrame.contentWindow.document.open("text/html", "replace");
doc.write(htmlDocument);
doc.close();
</code></pre>

<p>};
```</p>

<p>For printing contents of an element you can use this</p>

<p>```js
//element can be found by document.querySelectorAll(slector)[0]
//or using jQuery(selector)[0]
var printElement = function (element) {</p>

<pre><code>printHtml(element.innerHTML)
</code></pre>

<p>};
```</p>
]]></content>
  </entry>
  
</feed>
